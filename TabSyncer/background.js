console.log("[TabSyncer] background.ts loaded");const m="https://www.joker.blue",d=globalThis.__CACHE_PREFIX__||"ts_";function s(e){return`${d}${e}`}function h(e){chrome.contextMenus.removeAll(()=>{e?(chrome.contextMenus.create({id:"save_snapshot",title:"保存快照",contexts:["action"]}),chrome.contextMenus.create({id:"open_snapshots",title:"打开快照",contexts:["action"]}),chrome.contextMenus.create({id:"logout",title:"退出",contexts:["action"]})):chrome.contextMenus.create({id:"login",title:"登录",contexts:["action"]})})}chrome.runtime.onInstalled.addListener(()=>{l(e=>{console.log("[TabSyncer][onInstalled] token:",e),h(!!e)})});chrome.storage.onChanged.addListener((e,i)=>{const n=s("token");i==="local"&&n in e&&(console.log("[TabSyncer][onChanged] token:",e[n]),h(!!e[n].newValue))});function u(e){chrome.windows.getAll({populate:!0,windowTypes:["normal"]},i=>{var o;const n=i.find(t=>t.focused)||i[0],r=((o=n.tabs)==null?void 0:o.map(t=>({title:t.title,url:t.url,favIconUrl:t.favIconUrl})))||[];fetch(`${m}/tab/api/v1/snapshot/save`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({windowId:n.id,tabs:r,createdAt:new Date().toISOString()})}).then(t=>{if(t.ok)return t.json();throw new Error("Network response was not ok")}).then(()=>{chrome.notifications&&chrome.notifications.create&&chrome.notifications.create({type:"basic",iconUrl:"icon-128.png",title:"快照已保存",message:"当前窗口所有标签页已保存到云端"})}).catch(t=>{chrome.notifications&&chrome.notifications.create?chrome.notifications.create({type:"basic",iconUrl:"icon-128.png",title:"保存失败",message:"快照保存失败，请检查网络或重新登录"}):console.error("[TabSyncer] chrome.notifications API is undefined",t)})})}chrome.action.onClicked.addListener(()=>{l(e=>{if(console.log("[TabSyncer][action.onClicked] token:",e),!e){chrome.tabs.create({url:chrome.runtime.getURL("index.html#/login")});return}u(e)})});chrome.contextMenus.onClicked.addListener((e,i)=>{l(n=>{if(console.log("[TabSyncer][contextMenus.onClicked] token:",n,"menuItemId:",e.menuItemId),e.menuItemId==="login"){chrome.tabs.create({url:chrome.runtime.getURL("index.html#/login")});return}if(!n&&(e.menuItemId==="save_snapshot"||e.menuItemId==="open_snapshots")){chrome.tabs.create({url:chrome.runtime.getURL("index.html#/login")});return}if(e.menuItemId==="save_snapshot"){u(n);return}e.menuItemId==="open_snapshots"?chrome.tabs.create({url:chrome.runtime.getURL("index.html#/main")}):e.menuItemId==="logout"&&(f(),chrome.tabs.query({},r=>{const o=[chrome.runtime.getURL("index.html#/main"),chrome.runtime.getURL("index.html#/login")];r.forEach(t=>{t.url&&o.some(c=>t.url.startsWith(c))&&chrome.tabs.remove(t.id)})}),chrome.notifications.create({type:"basic",iconUrl:"icon-128.png",title:"已退出",message:"您已退出登录"}),chrome.tabs.create({url:chrome.runtime.getURL("index.html#/login")}))})});chrome.runtime.onMessage.addListener((e,i,n)=>{if(e.action==="openTabs"&&Array.isArray(e.tabs)){const r=e.tabs.map(o=>o.url).filter(Boolean);r.length&&chrome.windows.create({url:r,focused:!0})}e.action==="save_snapshot"&&l(r=>{if(!r){chrome.tabs.create({url:chrome.runtime.getURL("index.html#/login")});return}e.type==="current_tab"?chrome.tabs.query({active:!0,currentWindow:!0},o=>{const t=o[0];a(r,[t],t.windowId)}):e.type==="current_window"?chrome.windows.getAll({populate:!0,windowTypes:["normal"]},o=>{const t=o.find(c=>c.focused)||o[0];a(r,t.tabs||[],t.id)}):e.type==="all_windows"?chrome.windows.getAll({populate:!0},o=>{const t=o.flatMap(c=>c.tabs||[]);a(r,t,0)}):e.type==="split_windows"&&chrome.windows.getAll({populate:!0},o=>{o.forEach(t=>{a(r,t.tabs||[],t.id)})})})});function f(){console.log("[TabSyncer][removeToken]"),chrome.storage.local.remove(s("token"))}function l(e){chrome.storage.local.get([s("token")],i=>{const n=i[s("token")];console.log("[TabSyncer][getToken]",n),e(n)})}function a(e,i,n){const r=i.map(o=>({title:o.title,url:o.url,favIconUrl:o.favIconUrl}));fetch(`${m}/tab/api/v1/snapshot/save`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({windowId:n,tabs:r,createdAt:new Date().toISOString()})}).then(o=>{if(o.ok)return o.json();throw new Error("Network response was not ok")}).then(()=>{chrome.notifications&&chrome.notifications.create&&chrome.notifications.create({type:"basic",iconUrl:"icon-128.png",title:"快照已保存",message:"标签页快照已保存到云端"})}).catch(o=>{chrome.notifications&&chrome.notifications.create?chrome.notifications.create({type:"basic",iconUrl:"icon-128.png",title:"保存失败",message:"快照保存失败，请检查网络或重新登录"}):console.error("[TabSyncer] chrome.notifications API is undefined",o)})}
